---
title: "ã€è·¨åŸŸã€‘ã€è½¬ã€‘æµè§ˆå™¨åŒæºç­–ç•¥"
description: "åŒæºç­–ç•¥æ˜¯æµè§ˆå™¨çš„ä¸€ç§å®‰å…¨é™åˆ¶ï¼Œå®ƒé™åˆ¶äº†ä»åŒä¸€ä¸ªæºåŠ è½½çš„æ–‡æ¡£æˆ–è„šæœ¬å¦‚ä½•ä¸æ¥è‡ªå¦ä¸€ä¸ªæºçš„èµ„æºè¿›è¡Œäº¤äº’ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºéš”ç¦»æ½œåœ¨æ¶æ„æ–‡ä»¶çš„é‡è¦å®‰å…¨æœºåˆ¶ã€‚
"
date: "æ˜ŸæœŸå…­ï¼Œ27æ—¥ï¼Œ8æœˆï¼Œ2022 Â· ğŸ‘Œ"
type: "blog"
tags:
  - æŠ€æœ¯
  - è½¬è½½
---

# è·¨åŸŸå¤„ç†

## åŒæºç­–ç•¥

> åŒæºç­–ç•¥ï¼šSame Origin Policy
åœ¨è®¨è®ºè·¨åŸŸä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦è§£é‡Šä¸‹â€œåŒæºç­–ç•¥â€ï¼š

åŒæºç­–ç•¥æ˜¯æµè§ˆå™¨çš„ä¸€ç§å®‰å…¨é™åˆ¶ï¼Œå®ƒé™åˆ¶äº†ä»åŒä¸€ä¸ªæºåŠ è½½çš„æ–‡æ¡£æˆ–è„šæœ¬å¦‚ä½•ä¸æ¥è‡ªå¦ä¸€ä¸ªæºçš„èµ„æºè¿›è¡Œäº¤äº’ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºéš”ç¦»æ½œåœ¨æ¶æ„æ–‡ä»¶çš„é‡è¦å®‰å…¨æœºåˆ¶ã€‚

æˆ‘ä»¬åœ¨å‰ç«¯å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„æŸäº›èµ„æºï¼Œå¦‚ DOMã€Ajax/Fetch è¿”å›çš„å¼‚æ­¥æ•°æ®åŠæµè§ˆå™¨æœ¬åœ°å­˜å‚¨çš„ Cookieã€localStorage ç­‰ï¼Œä¸€èˆ¬ä¼šæ¯”è¾ƒæ•æ„Ÿã€‚

æƒ³è±¡ä»¥ä¸‹åœºæ™¯ï¼Œæˆ‘ä»¬ç™»å½•åœ¨çº¿é“¶è¡Œï¼Œè¿™ä¸ªç«™ç‚¹ä¾èµ– Cookie æ¥ä¿æŠ¤æˆ‘ä»¬çš„ç”¨æˆ·ä¿¡æ¯ï¼šåªæœ‰æ­£å¸¸ç™»å½•è®¤è¯è¿‡çš„ç”¨æˆ·ï¼ŒæœåŠ¡å™¨ç«¯ä¼šåœ¨æµè§ˆå™¨ä¸­å­˜å‚¨ä¸€ä¸ªç”Ÿæˆçš„ Cookie æ¥æ ‡è¯†è¿™ä¸ªç”¨æˆ·ï¼Œå…è®¸æ­£å¸¸è¿›è¡Œè½¬è´¦æ“ä½œã€‚è€Œåœ¨æµè§ˆå®Œè¿™ä¸ªç«™ç‚¹åï¼Œæˆ‘ä»¬åˆè®¿é—®äº†ä¸€ä¸ªæ¶æ„ç«™ç‚¹ï¼Œå¦‚æœæ²¡æœ‰åŒæºç­–ç•¥é™åˆ¶ï¼Œè¿™ä¸ªæ¶æ„ç½‘ç«™ä¹Ÿå¯ä»¥æ‹¿åˆ°é“¶è¡Œç«™ç‚¹å­˜å‚¨çš„ Cookie å¹¶ä¼ è¾“ç»™åˆ«äººï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ª Cookie è¿‡æœŸä¹‹å‰ï¼Œåˆ«äººå¯ä»¥æŠŠä½ çš„é“¶è¡Œå¡æ¬ç©ºã€‚ã€‚

å…³äº DOM æ“ä½œä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œè™šå‡é’“é±¼ç½‘ç«™ä»¥ iframe çš„æ–¹å¼åµŒå…¥äº†çœŸå®ç½‘ç«™ï¼Œæˆ‘ä»¬åœ¨è®¿é—®æ—¶å¯èƒ½æ ¹æœ¬å‘ç°ä¸äº†ï¼Œå¦‚æœæ²¡æœ‰åŒæºç­–ç•¥é™åˆ¶ï¼Œä¸»é¡µé¢å¯ä»¥ä»»æ„æ“ä½œå­é¡µé¢ä¸­ DOM å…ƒç´ ï¼Œæ¯”å¦‚åœ¨ç”¨æˆ·å¯†ç è¾“å…¥æ¡†ä¸Šå¢åŠ äº†é¢å¤–çš„äº‹ä»¶ç›‘å¬ï¼ŒåŒæ ·å¯ä»¥è¯±å¯¼æˆ‘ä»¬æš´éœ²ä¸ªäººæ•æ„Ÿä¿¡æ¯[^1]ã€‚

[^1]: å½“ç„¶ä¸ºäº†é˜²æ­¢æˆ‘ä»¬çš„ç«™ç‚¹è¢«åµŒå…¥åˆ°é’“é±¼ç«™ç‚¹çš„ iframe ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ meta å£°æ˜ã€åç«¯æœåŠ¡å™¨è®¾ç½®ç­‰è§„é¿ï¼Œå¦‚åœ¨ HTML ä¸­å¢åŠ å¦‚ä¸‹ meta: `<meta http-equiv="X-FRAME-OPTIONS" content="DENY">`ï¼Œå…¶ä»–è®¾ç½®å°†åœ¨ web å®‰å…¨ç« èŠ‚è¯¦ç»†è¯´æ˜ã€‚

è€Œæˆ‘ä»¬ç»å¸¸è§åˆ°çš„å¦ä¸€äº›èµ„æºï¼Œå¦‚ CSS æ ·å¼è¡¨æ–‡ä»¶ã€JS æ–‡ä»¶ã€å­—ä½“æ–‡ä»¶ã€å›¾ç‰‡ç­‰å› ä¸ºä¸å…·å¤‡æ•æ„Ÿä¿¡æ¯ï¼Œæ‰€ä»¥ä¸å—åŒæºç­–ç•¥é™åˆ¶ï¼Œè¿™äº›é™æ€èµ„æºæˆ‘ä»¬å¯ä»¥ä¾èµ– CDN æ¥éƒ¨ç½²å’Œåˆ†å‘ä»¥æé«˜ç”¨æˆ·ä½“éªŒï¼šä¸€æ–¹é¢ CDN èŠ‚ç‚¹ä¼—å¤šï¼Œå¯ä»¥å°±è¿‘å“åº”ç”¨æˆ·è¯·æ±‚ï¼›å¦ä¸€æ–¹é¢ï¼Œæµè§ˆå™¨åœ¨å‘èµ·è¯·æ±‚çš„æ—¶å€™ä¼šé»˜è®¤å¸¦ä¸Šæœ¬åŸŸçš„ Cookieï¼Œè€Œè¯·æ±‚é™æ€èµ„æºæ—¶æ˜æ˜¾ä¸éœ€è¦ Cookie ä¿æŠ¤ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½å¸¦ Cookie å¢å¤§äº†ç½‘ç»œå¸¦å®½æ¶ˆè€—ï¼Œæˆ‘ä»¬çš„ CDN åŸŸä¸€èˆ¬ä¸æˆ‘ä»¬çš„ç«™ç‚¹åŸŸä¸ä¸€è‡´ï¼Œå¯ä»¥è§„é¿è¿™ä¸ªé—®é¢˜ã€‚

## åˆ¤æ–­è·¨åŸŸ

åŒæºï¼šåè®®ã€åŸŸåã€ç«¯å£éƒ½ç›¸åŒã€‚è¯¦æƒ…å¯ä»¥å‚è§[è¿™é‡Œ](https://developer.mozilla.org/en-US/docs/Archive/Misc_top_level/Same-origin_policy_for_file:_URIs) ã€‚

ç¤ºä¾‹ï¼š

| URL                                      | ç»“æœ   | åŸå›                   |
| ---------------------------------------- | ---- | ------------------- |
| `http://store.company.com/dir2/other.html` | æˆåŠŸ   |                     |
| `http://store.company.com/dir/inner/another.html` | æˆåŠŸ   |                     |
| `https://store.company.com/secure.html`  | å¤±è´¥   | ä¸åŒåè®® ( httpså’Œhttp ) |
| `http://store.company.com:81/dir/etc.html` | å¤±è´¥   | ä¸åŒç«¯å£ ( 81å’Œ80)       |
| `http://news.company.com/dir/other.html` | å¤±è´¥   | ä¸åŒåŸŸå ( newså’Œstore ) |

## è·¨åŸŸæ•°æ®å­˜å‚¨è®¿é—®

### localStorage ä¸ IndexedDB

[localStorage](https://developer.mozilla.org/zh-CN/docs/Web/Guide/API/DOM/Storage) å’Œ [IndexedDB](https://developer.mozilla.org/zh-CN/docs/IndexedDB) å‡éµå¾ªä¸Šè¿°åŒæºç­–ç•¥é™åˆ¶ï¼Œå®ƒä»¬ä¸å…è®¸ JavaScript å¯¹è·¨åŸŸæ•°æ®è¿›è¡Œè¯»å†™æ“ä½œã€‚è¿™é™åˆ¶äº†æˆ‘ä»¬åœ¨ä¸åŒå­ç«™ç‚¹ä¸Šå…±äº«æ•°æ®çš„èƒ½åŠ›ï¼Œå¦‚æˆ‘ä»¬æƒ³åœ¨æˆ‘ä»¬äº§å“çš„ä¸¤ä¸ªç«™ç‚¹è§å…±äº«é£æ ¼é…ç½®ï¼Œç”¨æˆ·åˆ‡æ¢äº†ä¸€ä¸ªç«™ç‚¹çš„é£æ ¼ï¼ˆå¦‚å¯¼èˆªä¸ºæ·±è‰²ç­‰ï¼‰åï¼Œåœ¨åŒä¸€æµè§ˆå™¨ä¸­æ‰“å¼€çš„å¦ä¸€ä¸ªç«™ç‚¹ä¹Ÿä¿æŒåŒæ ·çš„é£æ ¼è®¾ç½®ï¼Œä¾é  localStorage æ˜¯åšä¸åˆ°çš„ï¼Œä¸€èˆ¬åšæ³•æ˜¯å­˜å‚¨åœ¨åç«¯ Redis ç­‰æœåŠ¡ä¸­ï¼Œé¡µé¢åŠ è½½çš„æ—¶å€™è¯»å–ä¸‹é…ç½®æ¥å£ã€‚

### Cookie

[Cookie](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Cookies) çš„ä½œç”¨åŸŸé™åˆ¶ä¸ localStorageã€IndexedDB è¿™äº›æ•°æ®å­˜å‚¨æ–¹æ¡ˆä¸åŒï¼Œå®ƒä½¿ç”¨`Domain` å’Œ `Path` æ¥è®¾ç½®ä½œç”¨åŸŸã€‚

å› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Cookie æ¥å®ç° localStorage ä¸ IndexedDB ç« èŠ‚ä¸­ç”¨æˆ·é…ç½®å…±äº«çš„ä¾‹å­ï¼Œä½†éœ€è¦æ³¨æ„ï¼Œè™½ç„¶æˆ‘ä»¬å¯ä»¥ç”¨ Cookie å¯ä»¥å®ç°ä¸Šè¿°éœ€æ±‚ï¼Œä½†ç”±äºæµè§ˆå™¨çš„æ¯æ¬¡è¯·æ±‚éƒ½ä¼šæºå¸¦ç¬¦åˆæ¡ä»¶çš„ Cookie æ•°æ®ï¼Œè¿™æ ·æ— ç–‘å¢å¤§äº†å¸¦å®½æ¶ˆè€—ï¼Œæ‰€ä»¥åœ¨å®é™…é¡¹ç›®ä¸­ä»ç„¶å»ºè®®é…ç½®ä¿¡æ¯å­˜å‚¨åœ¨åç«¯ï¼Œç”±æŒ‡å®šæ¥å£æä¾›ã€‚

æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Cookie çš„ Domain è®¾ç½®é…åˆ Oauth æ¥å®ç°æŒ‡å®šå­åŸŸåä¸‹æ‰€æœ‰ç«™ç‚¹çš„å•ç‚¹ç™»å½•ï¼š`*.xiaosansiji.com` æ˜¯æˆ‘ä»¬çš„ä¸€ä¸ªæ³›åŸŸåè§£æï¼Œå…¶ä¸‹æœ‰ `a.xiaosansiji.com`ã€`b.xiaosansiji.com` ç­‰å¤šä¸ªç«™ç‚¹ï¼Œæˆ‘ä»¬å¸Œæœ›ç™»å½•æŸä¸ªç«™ç‚¹åï¼Œå°±å¯ä»¥é»˜è®¤ç™»å½•æ‰€æœ‰ `xxx.xiaosansiji.com` ç«™ç‚¹ã€‚

å…·ä½“å®ç°ä¸ºï¼šç”¨æˆ·è®¿é—® `a.xiaosansiji.com` ç«™ç‚¹æ—¶ï¼Œè·³è½¬åˆ°å•ç‚¹ç™»å½•æœåŠ¡å™¨æä¾›çš„ç»Ÿä¸€ç™»å½•é¡µé¢ï¼Œç”¨æˆ·éªŒè¯é€šè¿‡åé‡å®šå‘è·³è½¬å› `a.xiaosansiji.com` ä¸»é¡µé¢ï¼Œåœ¨è¿™æ¬¡ HTTP è¯·æ±‚çš„ Response Header ä¸­å‘æµè§ˆå™¨ä¸­å­˜å‚¨ Cookie å¹¶è®¾ç½® Domain ä¸º `xiaosansiji.com` ï¼š

```javascript
Response Header
HTTP/1.1 302
Server: nginx/1.13.1
Date: Wed, 04 Jul 2018 06:48:43 GMT
Content-Length: 0
Location: http://a.xiaosansiji.com/
Connection: keep-alive
Set-Cookie: csid=D6ACED5C8AB99D5A3DB57594112AB00F;domain=xiaosansiji.com;path=/;HttpOnly
Content-Language: zh-CN
```

è¿™æ ·å½“æˆ‘ä»¬åœ¨åŒä¸€æµè§ˆå™¨ä¸­æ–°æ‰“å¼€çš„ä¸€ä¸ª Tab ä¸­è®¿é—® `b.xiaosansiji.com` ç«™ç‚¹æ—¶ï¼Œç³»ç»Ÿæç¤ºæˆ‘ä»¬å·²ç»ç™»å½•æˆåŠŸã€‚

æ³¨æ„æˆ‘ä»¬åœ¨ `Set-Cookie` æ—¶ä½¿ç”¨äº† `HttpOnly` æ ‡è®°ï¼Œè¿™ä¸»è¦æ˜¯ä»å®‰å…¨è§’åº¦ç¦æ­¢ JavaScript æ“ä½œè¯¥ Cookieï¼Œè¯¦ç»†å†…å®¹å‚è§ [ã€ŠWeb å®‰å…¨ã€‹]()ç« èŠ‚ã€‚

## è·¨åŸŸ HTTP è®¿é—®


åœ¨æ—¥å¸¸å‰ç«¯å¼€å‘å·¥ä½œä¸­ï¼Œæˆ‘ä»¬é‡åˆ°çš„æ›´å¤šæ˜¯ä¸Šé¢è¿™æ ·çš„æŠ¥é”™ï¼šæˆ‘ä»¬ä» `localhost:8000` å‘èµ·äº†ä¸€ä¸ª Ajax è¯·æ±‚åˆ° `www.google.com.hk` ç«™ç‚¹ï¼Œç„¶åæˆ‘ä»¬æ²¡èƒ½æ‹¿åˆ°æƒ³è¦çš„æ•°æ®ï¼Œåè€Œåœ¨ console ä¸­æç¤ºäº†ä¸Šå›¾çš„é”™è¯¯ã€‚

è¿™å…¶å®å°±æ˜¯å› ä¸ºåŒæºç­–ç•¥é™åˆ¶ï¼Œæˆ‘ä»¬çš„è·¨åŸŸè¯·æ±‚å¤±è´¥äº†ã€‚éœ€è¦æ³¨æ„å…¶å®æˆ‘ä»¬çš„è¯·æ±‚æ˜¯å·²ç»å‘é€åˆ°ç›®æ ‡æœåŠ¡å™¨äº†ï¼Œå¯¹æ–¹æ¥å£ä¹Ÿæ­£å¸¸è¿”å›äº†æ•°æ®ï¼Œåªæ˜¯åœ¨è¿”å›åˆ°æµè§ˆå™¨æ—¶è¢« block [^1]äº†ï¼ˆå›æƒ³æœ¬ç¯‡å¼€å¤´çš„åŒæºç­–ç•¥å®šä¹‰ï¼Œå®ƒæ˜¯**æµè§ˆå™¨**çš„å®‰å…¨ç­–ç•¥ï¼‰ã€‚

[^1]: é«˜ç‰ˆæœ¬çš„ Chrome å’Œ Firefox ç­‰ä¼šåœ¨ç«™ç‚¹é‡‡ç”¨ HTTPS çš„æƒ…å†µä¸‹ç›´æ¥é˜»æ­¢è¯·æ±‚å‘å‡ºå»ï¼Œè¿™æ—¶å€™åç«¯å…¶å®ä¸ä¼šæ¥æ”¶åˆ°è¯¥è¯·æ±‚ã€‚

æˆ‘ä»¬å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸‰ç§ï¼š

- JSONP ï¼šæ˜¯æŠŠè¯·æ±‚ä¼ªè£…æˆæ ‡ç­¾å»è¯·æ±‚ã€‚å› ä¸ºæ ‡ç­¾æ˜¯æµè§ˆå™¨è‡ªå·±å‘é€è¯·æ±‚ï¼Œæ‰€ä»¥ä¸å—åŒæºç­–ç•¥å½±å“å•Š
- åç«¯ Proxyï¼šè¿™ä¸ªä¹Ÿå¾ˆå¥½ç†è§£ï¼Œæˆ‘æŠŠæ‰€æœ‰è¯·æ±‚éƒ½å‘é€åˆ°ä¸è·¨åŸŸçš„ä»£ç†æœåŠ¡å™¨ä¸Šï¼ŒæœåŠ¡å™¨ä¸Šå¯æ˜¯æˆ‘ä»¬è¯´çš„ç®—ï¼Œåªè¦ç»è¿‡å¤„ç†æŠŠæ•°æ®è¿”å›ç»™æµè§ˆå™¨å°±å¥½ã€‚
- CORSï¼šè¿™æ˜¯æˆ‘ä»¬ä»Šå¤©ä¸»è¦è®²ã€‚å› ä¸ºè§£é“ƒè¿˜é¡»ç³»é“ƒäººï¼Œæ—¢ç„¶æ˜¯ä½ é™åˆ¶çš„ï¼Œé‚£ä¹ˆä½ æ€»å¾—ç»™æˆ‘ä¸€ä¸ªè§£å†³åŠæ³•å§ã€‚æµè§ˆå™¨ç»™å‡ºçš„è§£å†³åŠæ³•å°±æ˜¯ï¼ˆCORSï¼‰

### JSONP

> JSONPï¼šJSON with Padding
æˆ‘ä»¬åœ¨ä½¿ç”¨ jQuery ç­‰å°è£…çš„ Ajax åº“æ—¶ç»å¸¸è¿™æ ·ä½¿ç”¨ JSONPï¼š

```javascript
$.Ajax({
  type: "get",
  async: false,
  url: "http://demo.com/api/current?user=1",
  dataType: "jsonp",
  jsonp: "callback",//ä¼ é€’ç»™è¯·æ±‚å¤„ç†ç¨‹åºæˆ–é¡µé¢çš„ï¼Œç”¨ä»¥è·å¾—jsonpå›è°ƒå‡½æ•°åçš„å‚æ•°å(ä¸€èˆ¬é»˜è®¤ä¸º:callback)
  success: function(json){
    alert(json);
  },
});
```

è¿™è®©æˆ‘ä»¬äº§ç”Ÿäº†ä¸€ç§é”™è§‰ï¼Œä»¿ä½› JSONP ä¹Ÿæ˜¯ Ajax çš„ä¸€ç§ï¼Œæ¯•ç«Ÿæˆ‘ä»¬æ­£å¸¸å‘èµ·è¯·æ±‚æ—¶ä¹Ÿåªæ˜¯å°† `dataType` æ”¹ä¸º `json` è€Œå·²ã€‚

ä½† JSONP å…¶å®è·Ÿ Ajax/Fetch éƒ½æ²¡ä»€ä¹ˆå…³ç³»ï¼Œå®ƒç”¨ä¸€ç§æ¯”è¾ƒ hack çš„æ–¹å¼å®ç°è·¨åŸŸ HTTP æ¥å£äº¤äº’ï¼šåœ¨åŒæºç­–ç•¥ç« èŠ‚æˆ‘ä»¬å·²ç»è¯´è¿‡ï¼Œåœ¨é¡µé¢ä¸­ä½¿ç”¨ `script` æ ‡ç­¾åŠ è½½ CDN ä¸Šçš„ JavaScript èµ„æºæ–‡ä»¶æ˜¯ä¸å—åŒæºç­–ç•¥é™åˆ¶çš„ã€‚ç¨‹åºå‘˜ä»¬å°±æƒ³åˆ°å¦‚æœæˆ‘ä»¬è¯·æ±‚çš„ JavaScript æ–‡ä»¶æ˜¯åç«¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œåœ¨æµè§ˆå™¨ç«¯æ‰§è¡Œäº†è¿™ä¸€æ®µ JavaScript ä»£ç åå²‚ä¸æ˜¯å°±æ‹¿åˆ°äº†åç«¯æ¥å£çš„æ•°æ®ï¼

äºæ˜¯ä¸Šè¿°ä»£ç çš„åº•å±‚å®ç°å…¶å®æ˜¯è¿™æ ·çš„ï¼š

æµè§ˆå™¨ç«¯æˆ‘ä»¬éœ€è¦å¢åŠ å¦‚ä¸‹ä»£ç å‘èµ·è¯·æ±‚ï¼Œå¹¶å£°æ˜äº†è¯·æ±‚æˆåŠŸåå¤„ç†å‡½æ•°

```javascript
var callback = function(data){
    alert(data);
};
var url = "http://demo.com/api/current?user=1";
var script = document.createElement('script'); 
script.setAttribute('src', url); 
document.getElementsByTagName('head')[0].appendChild(script);
```

åœ¨æœåŠ¡å™¨ç«¯æˆ‘ä»¬éœ€è¦æŠŠæ­£å¸¸è¿”å›çš„æ•°æ®è½¬åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶ç”¨ callback åŒ…è£¹

```javascript
server.on('request', function(req, res) {
  var params = qs.parse(req.url.split('?')[1]);
  // jsonpè¿”å›è®¾ç½®
  res.writeHead(200, { 'Content-Type': 'text/javascript' });
  res.write('callback' + '(' + JSON.stringify(params) + ')');
  res.end();
});
```

è¿™æ ·é¡µé¢ä¸Šè¯·æ±‚åˆ°åç«¯æ•°æ®åå°±å¯ä»¥ç›´æ¥è°ƒç”¨ `callback` æ–¹æ³•è¿›è¡Œåç»­æ•°æ®å±•ç¤ºå¤„ç†äº†ã€‚

å¯ä»¥çœ‹åˆ° JSONP çš„åº•å±‚å®ç°è·Ÿ Ajax çš„ XHR å®Œå…¨ä¸åŒï¼Œåªæ˜¯ jQuery å¸®æˆ‘ä»¬å°è£…äº†è¿™äº›æ“ä½œè€Œå·²ã€‚

JSONP æ–¹æ¡ˆå¯ä»¥è¿è¡Œåœ¨ä»»ä½•å…è®¸æ‰§è¡Œ JavaScript è„šæœ¬çš„æµè§ˆå™¨ä¸Šï¼Œå…¼å®¹æ€§è¾ƒå¥½ï¼Œä½†ä¹Ÿå­˜åœ¨å¾ˆå¤šé™åˆ¶ï¼š

- éœ€è¦åç«¯åŒå­¦çš„æ”¯æŒï¼šæ­£å¸¸è¿”å›çš„ JSON æ•°æ®éœ€è¦å¤„ç†ä¸€ä¸‹ï¼Œå˜æˆæµè§ˆå™¨å¯ä»¥æ‰§è¡Œçš„è„šæœ¬
- ä»…æ”¯æŒ GET æ–¹æ³•çš„è¯·æ±‚ï¼šå¦‚ä»£ç ç¤ºä¾‹ä¸­å±•ç¤ºçš„ï¼Œæˆ‘ä»¬åªèƒ½å‘èµ· GET è¯·æ±‚ï¼Œä¸”æ‰€æœ‰å‚æ•°åªèƒ½æ·»åŠ åˆ° url ä¸­
- å¯¹äºé”™è¯¯çš„æ”¯æŒä¸å¥½ï¼šä¸åƒ Ajax å’Œ Fetch éƒ½æœ‰è¾ƒå¥½çš„é”™è¯¯å¤„ç†æ¥å£ï¼ŒJSONP å¤±è´¥äº†åªä¼šåœ¨æ§åˆ¶å°è¾“å‡ºä¸€å¥ error è€Œå·²

æ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬åœ¨æ—¥å¸¸ä¸åç«¯æ¥å£äº¤äº’ä¸­è¾ƒå°‘é‡‡ç”¨ JSONP æ–¹æ¡ˆï¼Œåœ¨æŠ•æ”¾å¹¿å‘Šç­‰é¢†åŸŸç”¨çš„æ¯”è¾ƒå¤šã€‚

### åç«¯ Proxy 

è¿™æ˜¯æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­æœ€å¸¸ç”¨çš„æ–¹æ¡ˆï¼Œå…·ä½“æ¥è¯´å°±æ˜¯è®©åç«¯å¯ä¸€ä¸ªä»£ç†æœåŠ¡ï¼Œæ¥ä»£æ›¿ç›´æ¥ç”±æµè§ˆå™¨å¯¹å…¶ä»–åŸŸçš„æ¥å£å‘èµ·è¯·æ±‚ã€‚

å¦‚ï¼Œæˆ‘ä»¬å°†ç«™ç‚¹éƒ¨ç½²åœ¨ Nginx ä¸Šï¼Œæœ‰ä¸¤ä¸ªå•ç‹¬éƒ¨ç½²çš„åç«¯æ¥å£åœ°å€ï¼ˆè¿™åœ¨åç«¯å¾®æœåŠ¡åº”ç”¨ä¸­å¾ˆå¸¸è§ï¼‰éœ€è¦è®¿é—®ï¼š

```nginx
server {  
    listen       80;  
    server_name  localhost;  
    #åå‘ä»£ç†åœ°å€ä¸ºhttp://a.demo.com/apiçš„åç«¯æ¥å£ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µæ”¹ä¸ºè‡ªå·±çš„åœ°å€
    location ^~ /api {
        proxy_pass http://a.demo.com;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        Host $http_host;
    }
    location ^~ /bpi {
        rewrite ^/bpi(.+) /api/$1 break;
        proxy_pass http://b.demo.com;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        Host $http_host;
    }
    ...
}
```

è¿™æ ·æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸Šå‘èµ·è¿™ä¸¤ç±»è¯·æ±‚æ—¶å…¶å®éƒ½å¯ä»¥è¯·æ±‚åˆ°è¿™ä¸ª Nginx èŠ‚ç‚¹ä¸Šï¼Œç”± Nginx æ ¹æ® url è·¯å¾„çš„ä¸åŒï¼ˆapi/bpiï¼‰æ¥åˆ†åˆ«è¯·æ±‚ä¸¤ä¸ªç«™ç‚¹çš„æ¥å£ã€‚

åç«¯ Proxy çš„æ–¹æ¡ˆå”¯ä¸€çš„ç¼ºç‚¹å°±æ˜¯éœ€è¦åç«¯å¼€å‘æˆ–è€…ä½¿ç”¨ Nginx/Apach ç­‰é…ç½®ä»£ç†ï¼Œåªèƒ½ç”¨äºåç«¯èƒ½å¤Ÿæ”¹é€ çš„å‰æä¸‹ã€‚

### CORS

> CORSï¼šcross-origin sharing è·¨åŸŸèµ„æºå…±äº«
å¯¹äº Ajax å’Œ Fetch æ¥è¯´ï¼ŒCORS æ˜¯ç°åœ¨æœ€å¯é çš„è·¨åŸŸè§£å†³æ–¹æ¡ˆï¼Œå®ƒæœ¬èº«å·²ç»åŠ å…¥ [W3C è§„èŒƒ](https://www.w3.org/TR/cors/) ã€‚ç°åœ¨å„ä¸»æµæµè§ˆå™¨éƒ½å…è®¸æœåŠ¡å™¨ç«¯è¿”å› HTTP è¯·æ±‚æ—¶å¢åŠ ç›¸åº” header è®¾ç½®ï¼Œä»¥å£°æ˜æµè§ˆå™¨ç«¯å‘å‡ºçš„è¯·æ±‚æœ‰æƒé™åšå“ªäº›æ“ä½œã€‚ä¸ŠèŠ‚è¯´è¿‡ï¼ŒåŒæºç­–ç•¥ä¼šä½¿å¾—æµè§ˆå™¨åœ¨æœåŠ¡ç«¯è¿”å›æ•°æ®æ—¶é˜»å¡è¯¥å“åº”ï¼Œè€Œå½“æˆ‘ä»¬åœ¨ Response header ä¸­å¢åŠ äº†ç›¸å…³ CORS å£°æ˜åï¼Œæµè§ˆå™¨å°±å¯ä»¥æ”¾è¡Œè¯¥å“åº”ï¼Œè®© JavaScript ç»§ç»­åç»­çš„æ•°æ®å¤„ç†å’Œå±•ç¤ºå·¥ä½œã€‚è¿™ç›¸å½“äºè®©æœåŠ¡å™¨ç«¯ä¸ºæˆ‘ä»¬çš„è¯·æ±‚â€œèƒŒä¹¦â€ï¼Œè¯¥æœåŠ¡å™¨æ˜ç¡®å‘ŠçŸ¥æµè§ˆå™¨ï¼šæˆ‘å…è®¸è¯¥ç«™ç‚¹è·¨åŸŸè·å–æˆ‘çš„æ¥å£æ•°æ®ã€‚

åœ¨ CORS ä¸­çš„é…ç½®åˆ†ä¸ºâ€œç®€å•è¯·æ±‚â€å’Œâ€œéœ€é¢„æ£€çš„è¯·æ±‚â€ä¸¤ç§ã€‚

#### ç®€å•è¯·æ±‚

æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼Œè§†ä¸ºâ€œç®€å•è¯·æ±‚â€ï¼š

- ä½¿ç”¨ä¸‹åˆ—æ–¹æ³•ä¹‹ä¸€ï¼š

  - `GET`
  - `HEAD`
  - `POST`

- æœªè®¾ç½®ä¸‹é¢åˆ—å‡ºä¹‹å¤–çš„å…¶ä»– header ï¼š

  - [`Accept`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept)

  - [`Accept-Language`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept-Language)

  - [`Content-Language`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Language)

  - [`Content-Type`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Type) åªèƒ½è®¾ç½®ä¸‰ç§ç±»å‹ï¼š

    - `text/plain`
    - `multipart/form-data`
    - `application/x-www-form-urlencoded`

    è¿˜æœ‰å¦‚ä¸‹å‡ ä¸ªä¸å¤ªå¸¸ç”¨ header è®¾ç½®

  - [`DPR`](http://httpwg.org/http-extensions/client-hints.html)

  - [`Downlink`](http://httpwg.org/http-extensions/client-hints.html#downlink)

  - [`Save-Data`](http://httpwg.org/http-extensions/client-hints.html#save-data)

  - [`Viewport-Width`](http://httpwg.org/http-extensions/client-hints.html#viewport-width)

  - [`Width`](http://httpwg.org/http-extensions/client-hints.html#width)

- è¯·æ±‚ä¸­çš„ä»»æ„[`XMLHttpRequestUpload`](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequestUpload) å¯¹è±¡å‡æ²¡æœ‰æ³¨å†Œä»»ä½•äº‹ä»¶ç›‘å¬å™¨ï¼›[`XMLHttpRequestUpload`](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequestUpload) å¯¹è±¡å¯ä»¥ä½¿ç”¨ [`XMLHttpRequest.upload`](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/upload) å±æ€§è®¿é—®ã€‚

- è¯·æ±‚ä¸­æ²¡æœ‰ä½¿ç”¨ [`ReadableStream`](https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream) å¯¹è±¡ã€‚

æ»¡è¶³ä»¥ä¸Šæ¡ä»¶çš„â€œç®€å•è¯·æ±‚â€ï¼Œæˆ‘ä»¬åªéœ€è¦è¦æ±‚æœåŠ¡å™¨ç«¯åœ¨è¿”å›å“åº”æ—¶æä¾› `Access-Control-Allow-Origin` çš„ header è®¾ç½®å°±å¯ä»¥äº†ï¼Œåœ¨çº¿ä¾‹å­å¯ä»¥æŸ¥çœ‹[è¿™é‡Œ](http://arunranga.com/examples/access-control/simpleXSInvocation.html)

```http
HTTP/1.1 200 OK
Date: Thu, 05 Jul 2018 02:18:58 GMT
Server: Apache
Access-Control-Allow-Origin: http://arunranga.com
Keep-Alive: timeout=2, max=100
Connection: Keep-Alive
Transfer-Encoding: chunked
Content-Type: application/xml
```

å¦‚ä¸Šï¼Œæˆ‘ä»¬åœ¨è·¨åŸŸçš„å¦ä¸€ä¸ªæœåŠ¡å™¨è¿”å›ä¸­è®¾ç½®äº† `Access-Control-Allow-Origin: http://arunranga.com` ï¼Œå³æ˜ç¡®å‘ŠçŸ¥æµè§ˆå™¨å…è®¸ `http://arunranga.com` ç«™ç‚¹çš„è¯·æ±‚è·å–æœ¬æœåŠ¡å™¨çš„æ•°æ®ã€‚

å½“ç„¶ï¼Œæœ‰äº›æä¾›å¤©æ°”/åœ°ç†æŸ¥è¯¢æœåŠ¡çš„ç½‘ç«™å¯èƒ½ä¼šå…è®¸ä»»ä½•å…¶ä»–ç«™ç‚¹è·å–æ•°æ®ï¼Œåˆ™ä¼šè®¾ç½® header ä¸º `Access-Control-Allow-Origin: *` ã€‚

åœ¨æœ‰ä¸€ç§æƒ…å†µä¸‹ï¼Œä¸å…è®¸è®¾ç½® `Access-Control-Allow-Origin: *`ï¼šè·¨åŸŸè¯·æ±‚çš„æ¥å£ä¾èµ– header ä¸­çš„ Cookie ä¿¡æ¯æ¥åšç”¨æˆ·éªŒè¯æ—¶ï¼Œæ ¹æ® CORS è§„èŒƒï¼Œè¯·æ±‚ä¸ä¼šè‡ªåŠ¨æºå¸¦è¯¥åŸŸä¸‹çš„ Cookieï¼Œå¯¹äº Fetch è¯·æ±‚æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®

```javascript
fetch(url, {
  credentials: 'include'  
})
```

ä»¥å…è®¸æºå¸¦ Cookieï¼Œå…·ä½“æƒ…å†µå¯å‚è€ƒ [`Request.credentials`](https://developer.mozilla.org/zh-CN/docs/Web/API/Request/credentials)ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬åªèƒ½è®¾ç½®`Access-Control-Allow-Origin: http://arunranga.com` ï¼Œå³åªèƒ½å…è®¸æŒ‡å®šåŸŸçš„è®¿é—®ï¼Œè€Œä¸èƒ½ä½¿ç”¨ `*` å…è®¸æ¥è‡ªæ‰€æœ‰åŸŸçš„è®¿é—®ã€‚

#### éœ€é¢„æ£€çš„è¯·æ±‚

ä¸æ»¡è¶³â€œç®€å•è¯·æ±‚â€æ¡ä»¶çš„æ‰€æœ‰è¯·æ±‚æˆ‘ä»¬éƒ½è§†ä¸ºâ€œéœ€é¢„æ£€çš„è¯·æ±‚â€ï¼Œå¦‚ `PUT` è¯·æ±‚ç­‰ã€‚å…¶ç‰¹æ®Šä¹‹å¤„åœ¨äºï¼šæˆ‘ä»¬ä¸ä»…éœ€è¦è®¾ç½® `Access-Control-Allow-Origin`ï¼Œè¿˜éœ€è¦è®¾ç½® `Access-Control-Allow-Methods` ç­‰ä»¥å…è®¸è¿™äº›è¯·æ±‚ã€‚

åœ¨ç®€å•è¯·æ±‚è¿‡ç¨‹ä¸­ï¼Œè¯¥è·¨åŸŸçš„è¯·æ±‚ä¸éè·¨åŸŸè¯·æ±‚å…¶å®æ˜¯ä¸€æ ·çš„ï¼šéƒ½ä»æµè§ˆå™¨ç«¯å‘é€è¯·æ±‚åˆ°äº†ç›®æ ‡æœåŠ¡å™¨ï¼Œåœ¨æµè§ˆå™¨æ¥æ”¶åˆ°å“åº”æ—¶å†åˆ¤æ–­æ˜¯å¦å…è®¸è·¨åŸŸå¤„ç†ã€‚

è€Œéœ€é¢„æ£€çš„è¯·æ±‚åˆ™ä¸æ˜¯è¿™æ ·ï¼šåœ¨å‘èµ·çš„æ­£å¼çš„ `PUT` ç­‰è¯·æ±‚å‰ï¼Œæµè§ˆå™¨ä¼šå…ˆä½¿ç”¨ [`OPTIONS`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/OPTIONS) æ–¹æ³•å‘èµ·ä¸€ä¸ªé¢„æ£€è¯·æ±‚ï¼Œä»¥è¯¢é—®æœåŠ¡å™¨æ˜¯å¦å…è®¸è¯¥è¯·æ±‚ï¼Œå¦‚æœå…è®¸æ‰ä¼šå‘é€å®é™…è¯·æ±‚ï¼Œå¯ä»¥æŸ¥çœ‹è¿™ä¸ªåœ¨çº¿[ä¾‹å­](http://arunranga.com/examples/access-control/preflightInvocation.html)ï¼š

![option-request.png](option-request.png)

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å‘èµ·äº†ä¸€ä¸ª `POST` è¯·æ±‚ï¼Œä½†å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº†éæ ‡å‡†çš„çš„ header è®¾ç½®ï¼Œæ‰€ä»¥ä»å±äºéœ€é¢„æ£€çš„è¯·æ±‚ã€‚è¿™ä¹Ÿæ˜¯æ¯”è¾ƒå¸¸è§çš„åšæ³•ï¼Œåœ¨ header ä¸­åŠ å…¥æŸäº›æˆ‘ä»¬è‡ªå·±å®šä¹‰å¤´ï¼Œå¦‚æ ‡è¯†ç”¨æˆ·æ‰€å±çš„ç»„ç»‡ç­‰ï¼š`x-current-group: 'dev'`ï¼Œç›¸åº”çš„åœ¨ CORS å¤„ç†ä¸­æˆ‘ä»¬éœ€è¦åœ¨å¢åŠ å…è®¸è¯¥ header çš„è®¾ç½®ï¼š`Access-Control-Allow-Headers': 'x-current-group'` ã€‚

å½“ç„¶å¦‚æœæˆ‘ä»¬æ¯å‘èµ·ä¸€ä¸ªéœ€é¢„æ£€çš„è¯·æ±‚éƒ½è¦å®é™…ä¸Šå‘é€ä¸¤æ¬¡ HTTP è¯·æ±‚ï¼ˆä¸€ä¸ª OPTIONS é¢„è¯·æ±‚ï¼Œä¸€ä¸ªæ­£å¼è¯·æ±‚ï¼‰ï¼Œå¯¹äºæœåŠ¡å™¨æ¥è¯´å¢å¤§äº†è®¿é—®å‹åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Response header ä¸­è®¾ç½® `'Access-Control-Max-Age': 600` æ¥è®©éªŒè¯é€šè¿‡åçš„10åˆ†é’Ÿå†…ä¸å†å‘é€é¢„è¯·æ±‚ã€‚

#### å¸¸è§ header è®¾ç½®

æ€»ç»“ä»¥ä¸Šç®€å•è¯·æ±‚å’Œéœ€é¢„æ£€çš„è¯·æ±‚ä½¿ç”¨åœºæ™¯ï¼Œå¸¸ç”¨çš„ CORS Response header è®¾ç½®æœ‰:

- [`Access-Control-Allow-Origin`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Origin):  `<origin> | *` ä¾‹ï¼Œ`http://arunranga.com`
- [`Access-Control-Expose-Headers`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Expose-Headers) : `<field-name>[, <field-name>]*` ä¾‹ï¼Œ`x-current-group`
- [`Access-Control-Allow-Methods`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Methods) : `<method>[, <method>]*` ä¾‹ï¼Œ`PUT, OPTIONS`
- [`Access-Control-Allow-Credentials`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials) : bool è®¾ç½®ä¸º `true` æ—¶å…è®¸æµè§ˆå™¨ç«¯æºå¸¦ Cookie ç­‰ Credentials è®¿é—®æ¥å£ï¼Œè¿™ä¸ªé™¤äº†æœåŠ¡ç«¯è¦è®¾ç½®å¤–ï¼Œæµè§ˆå™¨è¯·æ±‚çš„ä¸­ä¹Ÿè¦è®¾ç½®ï¼ŒAjax æ˜¯ `xhr.withCredentials = true;` Fetch ä¸­æ˜¯ `credentials: 'include'`
- [`Access-Control-Max-Age`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Max-Age) : æ³¨æ„å•ä½æ˜¯ç§’

### å…¶ä»– CORS ç”¨æ³•

æ³¨æ„ CORS å…¶å®ä¸ä»…é™äºè·¨åŸŸæ¥å£çš„è®¿é—®ï¼ŒHTML 5 è§„èŒƒä¸­ä¹Ÿå¯¹ CORS æä¾›äº†æ”¯æŒï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨åšå‰ç«¯å…¨å±€å¼‚å¸¸é‡‡é›†æ—¶ç»å¸¸è¦æ±‚å¼•å…¥çš„ Scripts åšå¦‚ä¸‹å¤„ç†ï¼š

```javascript
<script src="https://example.com/example.js" crossorigin="anonymous"></script>
```

å®ƒå…è®¸æˆ‘ä»¬å¯ä»¥è·å–è¯¥è·¨åŸŸè„šæœ¬æ‰§è¡Œå‡ºé”™æ—¶çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦åˆ™æˆ‘ä»¬å°±åªèƒ½åœ¨ç›‘å¬ window.onerror æ—¶å¾—åˆ°è¿™æ ·çš„æç¤ºï¼š`Script error.`

å…¶ä»–æ ‡ç­¾æ”¯æŒ CORS çš„æƒ…å†µï¼Œè¯·å‚çœ‹[è¿™é‡Œ](https://developer.mozilla.org/zh-CN/docs/Web/HTML/CORS_settings_attributes) ã€‚

## å‚è€ƒé“¾æ¥ï¼š
- [åŸæ–‡åœ°å€](https://github.com/xiaosansiji/cookbook-of-webdev/blob/master/http/cros-origin.md)
- [æµè§ˆå™¨è·¨åŸŸæ–¹æ³•ä¸åŸºäºFetchçš„Webè¯·æ±‚æœ€ä½³å®è·µ](https://segmentfault.com/a/1190000006095018)
- [æµè§ˆå™¨çš„åŒæºç­–ç•¥](https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy)
- [HTTP cookies](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Cookies)
- [JSONP æ•™ç¨‹](http://www.runoob.com/json/json-jsonp.html)
- [HTTPè®¿é—®æ§åˆ¶ï¼ˆCORSï¼‰](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS)

